# LlamaIndex å¯¦æˆ°ï¼šAdvanced Re-Rank & Chinese Hybrid Retrieval (Week 4)

æœ¬å°ˆæ¡ˆæ­£å¼é€²å…¥ Week 4ï¼šé€²éšæª¢ç´¢ç­–ç•¥èˆ‡å¤šèªè¨€å„ªåŒ–ã€‚
å»¶çºŒå¯æŒä¹…åŒ–çš„ RAG æ¶æ§‹ï¼Œé‡é»è§£æ±ºä¸­æ–‡ç’°å¢ƒä¸­æœ€æ£˜æ‰‹çš„ã€Œæ–·è©èˆ‡ç²¾æº–æª¢ç´¢ã€å•é¡Œï¼Œä¸¦æ­£å¼å°å…¥å¤šå±¤ç´š Re-Rankï¼ˆé‡æ’åºï¼‰ç®¡ç·šï¼Œä»¥æå‡æ•´é«” Retrieval Precision èˆ‡ LLM Context å“è³ªã€‚

---

## ğŸ“… æ›´æ–°è³‡è¨Š
- **åˆç‰ˆæ—¥æœŸ**ï¼š2026.01.07
- **æœ€æ–°æ›´æ–°**ï¼š2026.01.26  
- **ç­†è¨˜ç‰ˆæœ¬**ï¼šv1.1.0  
- **Notebook**ï¼š`notebook.ipynb`

---

## ğŸš€ æ ¸å¿ƒé‡é»

### 1. é€²éš Re-Rankï¼šå¾ã€Œå–®é»ã€åˆ°ã€Œè¤‡æ•¸ç®¡ç·šã€
ç•¶å‘é‡æœå°‹åˆç¯©å‡ºçš„ Top-K å€™é¸æ–‡ä»¶ä¾ç„¶åŒ…å«é›œè¨Šæ™‚ï¼Œæˆ‘å€‘ä½¿ç”¨ Re-Rank ä¾†æå‡ Precisionã€‚æœ¬é€±æ–°å¢äº†è¤‡æ•¸ Re-Rank ç­–ç•¥ï¼Œå¯¦ä½œã€Œåˆé¸ â†’ è¤‡é¸ â†’ æ±ºé¸ã€çš„æ¼æ–—æ©Ÿåˆ¶ã€‚

- FlagEmbeddingReranker (BGE): æœ¬åœ° Cross-Encoder æ¨¡å‹ï¼Œé©åˆè™•ç†ç¬¬ä¸€å±¤ç¯©é¸ï¼ˆTop 50 -> Top 20ï¼‰ï¼Œå…¼é¡§æ•ˆèƒ½èˆ‡éš±ç§ã€‚
- RankGPT (Listwise): åˆ©ç”¨ LLM çš„æ¨ç†èƒ½åŠ›é€²è¡Œåˆ—è¡¨æ’åºã€‚ä¸å†æ˜¯é€ä¸€è©•åˆ†ï¼Œè€Œæ˜¯è®“ LLM å¾å…¨å±€è¦–è§’åˆ¤æ–·å“ªäº›æ–‡ä»¶æœ€ç›¸é—œã€‚
- Cohere Rerank v4: ä¼æ¥­ç´šè¨—ç®¡æ–¹æ¡ˆï¼Œæ”¯æ´ 32k Context èˆ‡åŸç”Ÿ YAML/JSON çµæ§‹åŒ–è³‡æ–™æ’åºã€‚
- è¤‡æ•¸ Re-Rank (Ensemble):

    ç­–ç•¥å»ºè­°ï¼šå…ˆç”¨ BGE é€²è¡Œåˆæ­¥éæ¿¾ï¼Œå†äº¤ç”± Cohere æˆ– RankGPT é€²è¡Œæœ€å¾Œçš„ç²¾ç´°æ’åºï¼Œä»¥å¹³è¡¡ API æˆæœ¬èˆ‡å›æ‡‰é€Ÿåº¦ã€‚0

#### ğŸ”¹ FlagEmbeddingRerankerï¼ˆLocal, Cross-Encoderï¼‰
- ä½¿ç”¨ **BAAI/bge-reranker-large**
- æ¡ç”¨ **Cross-Encoder æ¶æ§‹**ï¼ŒåŒæ™‚è®€å– Query + Document
- é©åˆï¼š
  - æœ¬åœ° GPU
  - é«˜éš±ç§éœ€æ±‚
  - ä¸å¸Œæœ›æ‰¿æ“” API æˆæœ¬çš„å ´æ™¯
- æ ¸å¿ƒå–æ¨ï¼š
  - ç²¾åº¦æ¥µé«˜
  - åƒ…é©åˆ rerank Top-Kï¼ˆ10â€“50 ç­†ï¼‰

#### ğŸ”¹ RankGPTï¼ˆLLM Listwise Rerankingï¼‰
- ä½¿ç”¨ LLM é€²è¡Œ **åˆ—è¡¨å¼é‡æ’åº**
- èƒ½ç†è§£èªæ„ç´°ç¯€ã€é‚è¼¯èˆ‡ä½¿ç”¨è€…æ„åœ–
- å®šä½ç‚ºï¼š
  - **Final Polish**
  - é«˜åƒ¹å€¼æŸ¥è©¢çš„æœ€å¾Œä¸€é“å“è³ªé—œå¡
- ä»£åƒ¹ï¼š
  - é«˜ Token æˆæœ¬
  - è¼ƒé«˜å»¶é²

#### ğŸ”¹ Cohere Rerank v4ï¼ˆè¨—ç®¡å‹ï¼‰
- ä¼æ¥­ç´šé‡æ’åºæ–¹æ¡ˆ
- é—œéµå„ªå‹¢ï¼š
  - 32k Context
  - å¤šèªè¨€ / è·¨èªè¨€
  - çµæ§‹åŒ–è³‡æ–™æ’åº
- æä¾› Pro / Fast é›™ç‰ˆæœ¬ï¼Œå¹³è¡¡æˆæœ¬èˆ‡æ•ˆèƒ½

ğŸ“Œ **æ ¸å¿ƒè§€å¿µ**  
> Re-Rank ä¸æ˜¯è¬éˆä¸¹ï¼Œå®ƒåªå°ã€Œå·²ç¶“æ‰¾å°æ–¹å‘çš„å€™é¸çµæœã€æœ‰æ•ˆã€‚

---

### ä¸­æ–‡ Hybrid Retrieval çš„çªç ´ï¼šJieba + BM25s
åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼ŒBM25 åƒ…é™æ–¼è‹±æ–‡ã€‚æœ¬é€±æˆ‘å€‘æ­£å¼å°å…¥äº† ä¸­æ–‡æ–·è©æ•´åˆï¼Œè§£æ±ºé—œéµå­—æª¢ç´¢åœ¨ç¹é«”/ç°¡é«”ä¸­æ–‡ç’°å¢ƒä¸‹çš„å¤±æ•ˆå•é¡Œã€‚

- Jieba æ•´åˆ: ä½¿ç”¨ dict.txt.big ç¹é«”å­—å…¸å„ªåŒ–å°ç£ä½¿ç”¨è€…çš„æ–·è©ç²¾ç¢ºåº¦ã€‚
- å®¢è£½åŒ– Tokenizer: å¯¦ä½œ chinese_tokenize å‡½å¼ï¼Œæ•´åˆ nltk åœç”¨è©éæ¿¾èˆ‡ jieba æœå°‹æ¨¡å¼æ–·è©ã€‚
- BM25s å‡ç´š: è®“ BM25 ä¸å†åªæ˜¯èªæ„æœå°‹çš„é™„åº¸ï¼Œè€Œæ˜¯èƒ½ç²¾æº–æ•æ‰ã€Œå°ˆæœ‰åè©ã€èˆ‡ã€Œäººåã€çš„åˆ©å™¨ã€‚

---

### 3. Query Fusion èˆ‡ RAG-Fusion
é‡å°ä½¿ç”¨è€…å•é¡Œå¾€å¾€éæ–¼ç°¡çŸ­æˆ–æ¨¡ç³Šçš„å•é¡Œï¼Œæˆ‘å€‘å¯¦ä½œäº† QueryFusionRetrieverï¼š

- Query Rewrite: åˆ©ç”¨ LLM è‡ªå‹•ç”Ÿæˆ 4 å€‹ç›¸é—œæŸ¥è©¢ï¼Œå¾ä¸åŒèªæ„ç¶­åº¦æŒ–æ˜å‘é‡ç©ºé–“ã€‚
- FUSION_MODES: æ·±å…¥æ¯”è¼ƒä¸åŒçš„èåˆæ¼”ç®—æ³•ï¼š
  - RRF (Reciprocal Rank Fusion): æœ€æ¨è–¦çš„é€šç”¨æ–¹æ¡ˆï¼Œä¸éœ€åˆ†æ•¸æ­¸ä¸€åŒ–ã€‚
  - Relative Score Fusion: é©åˆç•¶ä¸åŒæª¢ç´¢å™¨çš„åˆ†æ•¸å…·æœ‰é«˜åº¦åƒè€ƒåƒ¹å€¼æ™‚ã€‚

ğŸ“Œ ç‰¹åˆ¥èªªæ˜ï¼š  
> ä¸­æ–‡ BM25 éœ€è¦é«˜åº¦å®¢è£½åŒ–æ–·è©ï¼Œæœ¬é€±åˆ»æ„é¿é–‹å¯¦ä½œç´°ç¯€ï¼Œå°ˆæ³¨åœ¨æª¢ç´¢æ¶æ§‹è¨­è¨ˆã€‚

---

### 4. ç›£æ§èˆ‡è¿½è¹¤ (Arize Phoenix)
å°å…¥ Arize Phoenix é€²è¡Œæœ¬åœ°è¿½è¹¤ã€‚é€éå¯è¦–åŒ–ä»‹é¢è§€å¯Ÿï¼š
- æª¢ç´¢éšæ®µæ‰¾å›äº†å“ªäº› Chunksï¼Ÿ
- Re-Rank å‰å¾Œçš„æ’åè®ŠåŒ–ã€‚
- LLM æœ€çµ‚ç”Ÿæˆå›ç­”æ™‚åƒè€ƒçš„ Context å®Œæ•´åº¦ã€‚

## ğŸ§  æ ¸å¿ƒè¨­è¨ˆåŸå‰‡ (Design Philosophy)
1. **æª¢ç´¢æ¼æ–—åŒ–**: å‘é‡æª¢ç´¢ (Top 50) -> BGE Re-Rank (Top 20) -> Cohere/RankGPT (Top 5-10) -> LLM Contextã€‚
2. **æ··åˆæª¢ç´¢æ˜¯æ¨™é…**: å‘é‡æœå°‹è§£æ±ºã€Œèªæ„ç›¸ä¼¼ã€ï¼ŒBM25 è§£æ±ºã€Œå­—é¢ç²¾æº–ã€ï¼Œç¼ºä¸€ä¸å¯ã€‚
3. **å¤šå±¤ Re-Rank çš„åƒ¹å€¼**: æå‡ Recall çš„åŒæ™‚ï¼Œç¢ºä¿é€²åˆ° LLM çš„ Context æ˜¯ã€Œé»ƒé‡‘ä¸Šä¸‹æ–‡ã€ï¼Œæ¸›å°‘å¹»è¦ºã€‚

---

## ğŸ› ï¸ æŠ€è¡“æ£§
- **Framework**ï¼šLlamaIndex
- **Vector Store**ï¼šFAISS
- **Sparse Retrieval**ï¼šBM25
- **Embedding Models**ï¼šHuggingFace (`BAAI/bge-m3`)
- **Chinese NLP**: jieba, bm25s
- **Re-Ranker**ï¼š
  - BGE Reranker
  - RankGPT
  - Cohere Rerank v4
- **Monitoring**: arize-phoenix
- **LLM**ï¼šOllama (gpt-oss:120b-cloud)
- **Language**ï¼šPython
